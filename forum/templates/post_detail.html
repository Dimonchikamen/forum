{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ—Å—Ç–∞ -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">{{ post.title }}</h2>
                {% if user == post.author %}
                <div>
                    <a href="{% url 'post_edit' post.id %}" class="btn btn-sm btn-light me-1">
                        <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </a>
                    <a href="{% url 'delete_post' post.id %}" class="btn btn-sm btn-outline-light">
                        <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                    </a>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                <p class="lead">{{ post.content }}</p>

                {% if post.file %}
                    {% with post.file.name|lower as filename %}
                        {% if ".jpg" in filename or ".jpeg" in filename or ".png" in filename or ".gif" in filename %}
                            <div class="mt-3 text-center">
                                <img src="{{ post.file.url }}"
                                     class="img-fluid rounded shadow-sm"
                                     alt="–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                                     style="max-height: 500px; object-fit: contain;">
                            </div>
                        {% else %}
                            <div class="mt-3">
                                <a href="{{ post.file.url }}" download
                                   class="btn btn-outline-secondary d-inline-flex align-items-center">
                                    <i class="bi bi-file-earmark-arrow-down me-1"></i>
                                    üìé –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª: {{ post.file.name|default:"—Ñ–∞–π–ª" }}
                                </a>
                            </div>
                        {% endif %}
                    {% endwith %}
                {% endif %}
            </div>
            <div class="card-footer text-muted small d-flex justify-content-between">
                <span>
                    <i class="bi bi-person me-1"></i>{{ post.author.username }}
                </span>
                <span>
                    <i class="bi bi-clock me-1"></i>{{ post.created_at|date:"d.m.Y H:i" }}
                </span>
            </div>
        </div>

        <!-- –†–∞–∑–¥–µ–ª –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
        <h3 class="mb-4">
            <i class="bi bi-chat-dots me-2"></i>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            <span class="badge bg-secondary rounded-pill ms-2">{{ comments|length }}</span>
        </h3>

        {% for comment in comments %}
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="h6 mb-0">
                        <i class="bi bi-person-circle text-primary me-1"></i>
                        {{ comment.author.username }}
                    </h5>
                    <small class="text-muted">
                        <i class="bi bi-clock me-1"></i>
                        {{ comment.created_at|date:"d.m.Y H:i" }}
                    </small>
                </div>
                <p class="mb-2">{{ comment.text }}</p>

                {% if comment.file %}
                    {% with comment.file.name|lower as filename %}
                        {% if ".jpg" in filename or ".jpeg" in filename or ".png" in filename or ".gif" in filename %}
                            <div class="mt-2">
                                <img src="{{ comment.file.url }}"
                                     class="img-fluid rounded border"
                                     alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—é"
                                     style="max-height: 300px; object-fit: cover;">
                            </div>
                        {% else %}
                            <div class="mt-2">
                                <a href="{{ comment.file.url }}" download
                                   class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-file-earmark-arrow-down me-1"></i>
                                    –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                                </a>
                            </div>
                        {% endif %}
                    {% endwith %}
                {% endif %}

                {% if user == comment.author %}
                <div class="mt-2">
                    <a href="{% url 'edit_comment' comment.id %}" class="btn btn-sm btn-outline-primary me-1">
                        <i class="bi bi-pencil-square"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </a>
                    <a href="{% url 'delete_comment' comment.id %}"
                       class="btn btn-sm btn-outline-danger"
                       onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')">
                        <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info d-flex align-items-center">
            <i class="bi bi-info-circle me-2"></i>
            –ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
        </div>
        {% endfor %}

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h4 class="h5 mb-0">
                    <i class="bi bi-plus-circle me-2"></i>
                    {% if user.is_authenticated %}–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π{% else %}–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å{% endif %}
                </h4>
            </div>
            <div class="card-body">
                {% if user.is_authenticated %}
                <form method="post" action="{% url 'add_comment' post.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_text" class="form-label visually-hidden">–¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è</label>
                        <textarea name="text"
                                  class="form-control"
                                  rows="3"
                                  placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                                  required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="id_file" class="form-label">
                            <i class="bi bi-paperclip me-1"></i>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                        </label>
                        <input type="file" name="file" class="form-control" id="id_file">
                        <div class="form-text text-muted small">
                            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (jpg, png, gif) –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã.
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send me-1"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </form>
                {% else %}
                <p class="mb-0">
                    <a href="{% url 'login' %}" class="btn btn-outline-primary">
                        <i class="bi bi-box-arrow-in-right me-1"></i>–í–æ–π—Ç–∏
                    </a>
                    –∏–ª–∏
                    <a href="{% url 'register' %}" class="btn btn-primary">
                        <i class="bi bi-person-plus me-1"></i>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                    </a>
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}